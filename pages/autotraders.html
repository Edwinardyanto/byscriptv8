<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Autotraders | Trading Dashboard</title>
    <link rel="stylesheet" href="../src/styles/color-tokens.css">
    <link rel="stylesheet" href="../src/styles/main.css">
    <style>
      .page-autotraders .status-pill.active {
        color: var(--color-status-positive);
        border: 1px solid var(--color-action-primary-border);
        background: var(--color-component-status-pill-bg);
      }

      .page-autotraders .status-pill.stopped {
        color: var(--color-status-negative);
        border: 1px solid var(--color-status-negative-border);
        background: var(--color-component-status-pill-bg);
      }

      .page-autotraders .page-button.active {
        border-color: var(--color-action-primary-border-strong);
        color: var(--color-text);
      }

      .page-autotraders .text-green {
        color: var(--color-status-positive);
      }

      .page-autotraders .text-red {
        color: var(--color-status-negative);
      }

      .page-autotraders .performance-metrics {
        display: grid;
        grid-template-rows: repeat(3, minmax(0, auto));
        gap: 0;
        --metric-positive: var(--color-status-positive);
        --metric-negative: var(--color-status-negative);
      }

      .page-autotraders .metrics-stack {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        column-gap: 24px;
        row-gap: 14px;
      }

      .page-autotraders .metric-card {
        display: flex;
        flex-direction: column;
        gap: 6px;
        padding: 12px 0;
        border-radius: 0;
        background: transparent;
        border: none;
      }

      .page-autotraders .metric-card:nth-child(n + 3) {
        border-top: 1px solid var(--color-border-subtle);
        padding-top: 14px;
      }

      .page-autotraders .metric-card .metric-label {
        font-size: 0.62rem;
        color: var(--color-muted);
        text-transform: uppercase;
        letter-spacing: 0.12em;
        opacity: 0.55;
      }

      .page-autotraders .metric-card .metric-value {
        display: block;
        text-align: left;
        font-size: 0.98rem;
        font-weight: 500;
      }

      .page-autotraders .metric-card .metric-sub {
        font-size: 0.78rem;
        color: var(--color-text-secondary);
        display: block;
        margin-top: 8px;
      }

      .page-autotraders .metric-card .metric-sub-value {
        font-weight: 500;
      }

      .page-autotraders .metric-card .metric-sub-positive {
        color: var(--metric-positive);
      }

      .page-autotraders .metric-card .metric-sub-negative {
        color: var(--metric-negative);
      }

      .page-autotraders .metric-card .metric-breakdown {
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }

      .page-autotraders .metric-card .metric-sub-divider {
        color: var(--color-text-disabled);
      }

      .page-autotraders .autotraders-live {
        display: inline-flex;
        align-items: center;
        justify-content: flex-start;
        flex-direction: row;
        min-height: auto;
        
        gap: 8px;
        padding: 8px 12px;
        border-radius: 18px;
        background: var(--color-surface-panel-muted);
        border: 1px solid var(--color-action-primary-border-subtle);
        box-shadow: 0 0 16px var(--color-shadow-soft);
        line-height: 1;
      }

      

      .page-autotraders .live-indicator {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: var(--color-status-positive);
        box-shadow: 0 0 8px var(--color-shadow-soft);
        animation: livePulse 1.5s ease-in-out infinite;
      }

      .page-autotraders .live-item {
        font-size: 0.9rem;
        color: var(--color-text);
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .page-autotraders .live-label {
        font-size: 0.7rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--color-muted);
      }

      .page-autotraders .live-label::after {
        content: ":";
        margin-left: 4px;
      }

      .page-autotraders .live-value {
        font-size: 0.9rem;
        color: var(--color-text);
      }

      .page-autotraders .live-divider {
        width: 1px;
        align-self: stretch;
        background: var(--color-overlay-lg);
        margin: 0 6px;
      }

      .page-autotraders .autotraders-table {
      }

      @keyframes livePulse {
        0%,
        100% {
          opacity: 0.35;
          transform: scale(0.9);
        }
        50% {
          opacity: 1;
          transform: scale(1.2);
        }
      }

    </style>
  </head>
  <body class="page-autotraders">
    <div id="app" class="app">
      <header class="header section section--header section-header autotraders-header">
        <div class="section-header autotraders-header-row">
          <h1 class="section-title">Autotraders</h1>
          <a class="button autotraders-add-button" href="autotraders/new.html">+ Add Autotrader</a>
        </div>
      </header>
      <div class="app-body">
        <aside data-sidebar-slot></aside>
        <main class="main autotraders-main">
          <div class="autotraders-page">
            <section class="autotraders-performance autotraders-chart section section--primary">
            <div class="section-header">
              <div class="section-title-group">
                <h2 class="section-title">Total Autotraders Performance</h2>
                <div class="timeframe-pills" aria-label="Autotraders performance timeframe"></div>
              </div>
            </div>
            <div class="section-body">
              <div class="performance-layout">
                <div class="performance-chart">
                  <div class="total-performance-chart" data-total-performance="autotraders"></div>
                </div>
                <div class="performance-metrics">
                  <div class="metric-row">
                    <span class="metric-label">Profit Factor</span>
                    <span class="metric-value" id="metric-profit-factor">2.1</span>
                    <span class="metric-subvalue">(Gross Profit / Gross Loss)</span>
                  </div>
                  <div class="metric-row">
                    <span class="metric-label">Trades</span>
                    <span class="metric-value" id="metric-trades">10,234</span>
                    <span class="metric-subvalue">(Winning / Losing Trades)</span>
                  </div>
                  <div class="metric-row">
                    <span class="metric-label">Volume</span>
                    <span class="metric-value" id="metric-volume">$294,305,000</span>
                    <span class="metric-subvalue">(Total Executed Volume)</span>
                  </div>
                </div>
              </div>
            </div>
            </section>
            <section class="autotraders-live autotraders-summary section section--secondary">
            <span class="live-indicator" aria-hidden="true"></span>
            <span class="live-item" id="live-autotraders">
              <span class="live-label">Autotraders</span>
              <span class="live-value">
                <span id="live-autotraders-total">201</span>
                (<span
                  class="text-green"
                  id="live-autotraders-active"
                  title="Active autotraders currently running"
                >151</span> /
                <span
                  class="text-red"
                  id="live-autotraders-stopped"
                  title="Stopped autotraders"
                >50</span>)
              </span>
            </span>
            <span class="live-divider" aria-hidden="true"></span>
            <span class="live-item" id="live-capital">
              <span class="live-label">Capital Allocation</span>
              <span class="live-value" id="live-capital-value">$305,000</span>
            </span>
          </section>
            <section class="autotraders-table section section--secondary">
              <div class="section-body">
                <div class="table-scroll">
                  <table>
                    <thead>
                      <tr>
                        <th>Status</th>
                        <th class="col-trading-plan">Trading Plan</th>
                        <th>Pair</th>
                        <th>Exchange</th>
                        <th>Capital</th>
                        <th>PnL ($)</th>
                        <th>Win Rate</th>
                        <th>Running</th>
                        <th>Action</th>
                        <th>Detail</th>
                      </tr>
                    </thead>
                    <tbody id="autotraders-tbody"></tbody>
                  </table>
                </div>
                <div class="table-pagination" aria-label="Pagination">
                  <button class="page-button pagination-btn active" type="button" data-page="1">1</button>
                  <button class="page-button pagination-btn" type="button" data-page="2">2</button>
                  <button class="page-button pagination-btn" type="button" data-page="3">3</button>
                  <button class="page-button pagination-btn" type="button" data-page="4">4</button>
                  <button class="page-button pagination-btn" type="button" data-page="5">5</button>
                  <span class="page-ellipsis">…</span>
                  <button class="page-button next" type="button">Next ›</button>
                </div>
              </div>
            </section>
          </div>
        </main>
      </div>
    </div>
    <script type="module" src="../src/scripts/main.js"></script>
    <script type="module">
      import { renderTotalPerformanceChart } from "../src/scripts/components/TotalPerformanceChart.js";
      import {
        getAccounts,
        getAutotradersByAccount,
        getTradeHistory,
      } from "../src/scripts/dataAccess.js";

      const buildSeries = (points, start, end) => {
        const trend = (end - start) / Math.max(points - 1, 1);
        return Array.from({ length: points }, (_, index) => {
          const base = start + trend * index;
          const variance = Math.sin(index / 4) * 90 + Math.sin(index / 12) * 45;
          return Math.round(base + variance);
        });
      };

      const PAGE_SIZE = 10;
      let currentPage = 1;

      const performanceContainer = document.querySelector(
        ".page-autotraders [data-total-performance=\"autotraders\"]"
      );
      const paginationContainer = document.querySelector(".table-pagination");

      const autotradersPerformance = {
        totalBalance: "",
        change: "",
        changeLabel: "",
        chart: {
          activeRange: "7D",
          fullSeries: [],
          ranges: {},
        },
      };

      const normalizeRangeKey = (range) => (range === "all" ? "All" : range);

      const buildChartSeries = (points, metrics) => {
        const endValue = Math.max(80, Math.abs(metrics.pnl) + 140);
        const startValue = Math.max(20, endValue * 0.65);
        return buildSeries(points, startValue, endValue);
      };

      const renderAutotradersPerformance = (handleRangeChange) => {
        renderTotalPerformanceChart({
          container: performanceContainer,
          dataSource: "autotraders",
          data: autotradersPerformance,
          status: "ready",
          onRangeChange: handleRangeChange,
          timeframeContainer: document.querySelector(
            ".autotraders-performance .section-header .timeframe-pills"
          ),
        });
      };

      const renderRow = (row) => {
        const pnlClass = row.pnl < 0 ? "pnl-negative" : "pnl-positive";
        const statusClass = row.status === "ACTIVE" ? "active" : "stopped";
        const actionLabel = row.status === "ACTIVE" ? "Stop" : "Start";
        return `
          <tr>
            <td><span class="status-pill ${statusClass}">${row.status}</span></td>
            <td class="col-trading-plan"><span class="trading-plan-name">${row.name}</span></td>
            <td>${row.pair}</td>
            <td>${row.exchange}</td>
            <td>$${row.capital.toLocaleString()}</td>
            <td class="${pnlClass}">${row.pnl < 0 ? "-" : "+"}$${Math.abs(row.pnl)}</td>
            <td>${row.winRate}%</td>
            <td>${row.running}</td>
            <td><button class="table-action action-btn" type="button" data-id="${row.id}">${actionLabel}</button></td>
            <td><button class="table-action detail-btn" type="button" data-id="${row.id}">View</button></td>
          </tr>
        `;
      };

      const renderPagination = (totalPages, onPageChange) => {
        if (!paginationContainer) {
          return;
        }
        paginationContainer.innerHTML = "";
        if (totalPages <= 1) {
          return;
        }
        for (let page = 1; page <= totalPages; page += 1) {
          const button = document.createElement("button");
          button.type = "button";
          button.className = `page-button pagination-btn${page === currentPage ? " active" : ""}`;
          button.dataset.page = String(page);
          button.textContent = String(page);
          button.addEventListener("click", () => onPageChange(page));
          paginationContainer.appendChild(button);
        }
      };

      const initAutotradersPage = async () => {
        const storedAutotraders = JSON.parse(
          localStorage.getItem("byscript_custom_autotraders") || "[]"
        );
        const accounts = await getAccounts();
        const accountMap = new Map(accounts.map((account) => [account.account_id, account]));
        const autotradersByAccount = await Promise.all(
          accounts.map((account) => getAutotradersByAccount(account.account_id))
        );
        const coreAutotraders = autotradersByAccount.flat();
        const trades = await getTradeHistory();
        const latestTradeByAutotrader = trades.reduce((acc, trade) => {
          if (!acc.has(trade.autotrader_id)) {
            acc.set(trade.autotrader_id, trade);
          }
          return acc;
        }, new Map());

        const mappedAutotraders = coreAutotraders.map((autotrader) => {
          const account = accountMap.get(autotrader.account_id);
          const trade = latestTradeByAutotrader.get(autotrader.autotrader_id);
          const assetSymbol = trade?.assetSymbol || "BTC";
          return {
            id: autotrader.autotrader_id,
            name: autotrader.tradingPlanName || "Autotrader",
            pair: `${assetSymbol}_USDT`,
            exchange: account?.provider || "Exchange",
            capital: Number(autotrader.capital_usd || 0),
            pnl: Number(autotrader.pnl_usd || 0),
            winRate: Number(autotrader.win_rate || 0),
            running: autotrader.is_running ? 1 : 0,
            status: autotrader.is_running ? "ACTIVE" : "STOPPED",
          };
        });

        const autotradersList = [...storedAutotraders, ...mappedAutotraders];

        const buildMetrics = (rangeDays) => {
          const now = Date.now();
          const cutoff = rangeDays
            ? new Date(now - rangeDays * 24 * 60 * 60 * 1000)
            : null;
          const scopedTrades = cutoff
            ? trades.filter((trade) => trade.executedAt >= cutoff)
            : trades;
          const totalTrades = scopedTrades.length;
          const winTrades = scopedTrades.filter((trade) => trade.result === "win").length;
          const lossTrades = totalTrades - winTrades;
          const volume = scopedTrades.reduce((sum, trade) => sum + Number(trade.valueUsd || 0), 0);
          const pnl = scopedTrades.reduce((sum, trade) => sum + Number(trade.pnl_usd || 0), 0);
          const profit = scopedTrades.reduce(
            (sum, trade) => sum + Math.max(Number(trade.pnl_usd || 0), 0),
            0
          );
          const loss = scopedTrades.reduce(
            (sum, trade) => sum + Math.abs(Math.min(Number(trade.pnl_usd || 0), 0)),
            0
          );
          const capital = autotradersList.reduce((sum, bot) => sum + Number(bot.capital || 0), 0);
          const pnlPct = capital ? (pnl / capital) * 100 : 0;
          const activeCount = autotradersList.filter((bot) => bot.status === "ACTIVE").length;
          const stoppedCount = autotradersList.length - activeCount;
          return {
            pnl,
            pnlPct,
            volume,
            trades: { total: totalTrades, win: winTrades, loss: lossTrades },
            capital,
            profit,
            loss: loss || 1,
            autotraders: { active: activeCount, stopped: stoppedCount },
          };
        };

        const autotradersData = {
          "7D": {
            chart: [],
            metrics: buildMetrics(7),
          },
          "30D": {
            chart: [],
            metrics: buildMetrics(30),
          },
          "90D": {
            chart: [],
            metrics: buildMetrics(90),
          },
          All: {
            chart: [],
            metrics: buildMetrics(null),
          },
        };

        autotradersData["7D"].chart = buildChartSeries(7, autotradersData["7D"].metrics);
        autotradersData["30D"].chart = buildChartSeries(30, autotradersData["30D"].metrics);
        autotradersData["90D"].chart = buildChartSeries(90, autotradersData["90D"].metrics);
        autotradersData.All.chart = buildChartSeries(120, autotradersData.All.metrics);

        autotradersPerformance.chart.fullSeries = autotradersData.All.chart;
        autotradersPerformance.chart.ranges = {
          "7D": autotradersData["7D"].chart,
          "30D": autotradersData["30D"].chart,
          "90D": autotradersData["90D"].chart,
        };

        const updatePerformanceSummary = (range) => {
          const rangeKey = normalizeRangeKey(range);
          const metrics = autotradersData[rangeKey]?.metrics;
          if (!metrics) {
            return;
          }
          const pnlPctValue = Number(metrics.pnlPct || 0);
          const pnlPctSign = pnlPctValue > 0 ? "+" : pnlPctValue < 0 ? "-" : "";

          autotradersPerformance.totalBalance = `+$${metrics.pnl.toLocaleString()}`;
          autotradersPerformance.change = `${pnlPctSign}${Math.abs(pnlPctValue).toFixed(1)}%`;
          autotradersPerformance.changeLabel =
            rangeKey === "All" ? "vs all time" : `vs last ${rangeKey.toLowerCase()}`;
          autotradersPerformance.chart.activeRange = range;
        };

        const updateGlobalMetrics = (range) => {
          const rangeKey = normalizeRangeKey(range);
          const m = autotradersData[rangeKey]?.metrics;
          if (!m) {
            return;
          }
          const profitFactor = (m.profit / m.loss).toFixed(1);
          document.querySelector("#metric-profit-factor").innerText = profitFactor;
          document.querySelector("#metric-trades").innerText = `${m.trades.total.toLocaleString()}`;
          document.querySelector("#metric-volume").innerText = `$${m.volume.toLocaleString()}`;
          updateCapitalAllocation();
        };

        const updateCapitalAllocation = () => {
          const activeCapital = autotradersList
            .filter((bot) => bot.status === "ACTIVE")
            .reduce((sum, bot) => sum + bot.capital, 0);
          document.querySelector("#live-capital-value").innerText = `$${activeCapital.toLocaleString()}`;
        };

        const updateLiveAutotraders = () => {
          const active = autotradersList.filter((bot) => bot.status === "ACTIVE").length;
          const stopped = autotradersList.filter((bot) => bot.status === "STOPPED").length;
          document.querySelector("#live-autotraders-total").innerText = autotradersList.length;
          document.querySelector("#live-autotraders-active").innerText = active;
          document.querySelector("#live-autotraders-stopped").innerText = stopped;
        };

        const renderAutotradersPage = (page) => {
          const start = (page - 1) * PAGE_SIZE;
          const end = start + PAGE_SIZE;
          const rows = autotradersList.slice(start, end);
          const tbody = document.querySelector("#autotraders-tbody");
          if (!tbody) {
            return;
          }
          tbody.innerHTML = "";
          rows.forEach((row) => {
            tbody.insertAdjacentHTML("beforeend", renderRow(row));
          });
        };

        const handleRangeChange = (range) => {
          updatePerformanceSummary(range);
          updateGlobalMetrics(range);
          renderAutotradersPerformance(handleRangeChange);
        };

        const handlePageChange = (page) => {
          currentPage = page;
          renderAutotradersPage(currentPage);
          renderPagination(Math.ceil(autotradersList.length / PAGE_SIZE), handlePageChange);
        };

        document.addEventListener("click", (e) => {
          const target = e.target;
          if (!(target instanceof HTMLElement)) {
            return;
          }

          if (target.classList.contains("detail-btn")) {
            const id = target.dataset.id;
            if (!id) {
              return;
            }
            window.location.href = `autotraders/detail.html?id=${encodeURIComponent(id)}`;
            return;
          }

          if (!target.classList.contains("action-btn")) {
            return;
          }

          const id = target.dataset.id;
          const bot = autotradersList.find((entry) => String(entry.id) === String(id));

          if (!bot) {
            return;
          }

          if (bot.status === "ACTIVE") {
            bot.status = "STOPPED";
            bot.running = 0;
          } else {
            bot.status = "ACTIVE";
            bot.running = 1;
          }

          renderAutotradersPage(currentPage);
          updateLiveAutotraders();
          updateCapitalAllocation();
        });

        updatePerformanceSummary("7D");
        updateGlobalMetrics("7D");
        renderAutotradersPerformance(handleRangeChange);
        renderAutotradersPage(currentPage);
        renderPagination(Math.ceil(autotradersList.length / PAGE_SIZE), handlePageChange);
        updateLiveAutotraders();
        updateCapitalAllocation();
      };

      initAutotradersPage();
    </script>
  </body>
</html>
