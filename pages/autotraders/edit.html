<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Autotrader Editor | ByScript</title>
    <link rel="stylesheet" href="../../src/styles/color-tokens.css">
    <link rel="stylesheet" href="../../src/styles/main.css">
    <style>
      .page-autotrader-config {
        --config-panel-max-height: 680px;
        --pairs-row-height: 48px;
        --pairs-visible-rows: 5;
        --pairs-scroll-padding: 8px;
      }

      .page-autotrader-config .section--header {
        display: grid;
        gap: 6px;
      }

      .page-autotrader-config .section-title {
        font-size: 1.6rem;
      }

      .page-autotrader-config .section-subtitle {
        color: var(--color-text-tertiary);
        font-size: 0.95rem;
      }

      .page-autotrader-config .configurator-layout {
        display: grid;
        grid-template-columns: minmax(0, 1.35fr) minmax(0, 0.9fr);
        gap: 20px;
        align-items: start;
      }

      .page-autotrader-config .config-panel,
      .page-autotrader-config .summary-panel {
        background: var(--color-surface-panel-muted);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        padding: 18px;
        box-shadow: var(--shadow-soft);
      }

      .page-autotrader-config .config-panel {
        max-height: var(--config-panel-max-height);
        height: var(--config-panel-max-height);
        overflow: hidden;
      }

      .page-autotrader-config .config-section + .config-section {
        margin-top: 18px;
        padding-top: 18px;
        border-top: 1px solid var(--color-overlay-md);
      }

      .page-autotrader-config .config-section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 12px;
      }

      .page-autotrader-config .config-section-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--color-text-primary);
      }

      .page-autotrader-config .config-section-description,
      .page-autotrader-config .section-description,
      .page-autotrader-config .section-helper,
      .page-autotrader-config .pairs-description {
        color: var(--color-text-secondary);
        font-size: 0.85rem;
      }

      .page-autotrader-config .toggle-group {
        display: inline-flex;
        gap: 6px;
        padding: 4px;
        border-radius: 8px;
        border: 1px solid var(--color-overlay-sm);
        background: transparent;
        height: 38px;
        align-items: center;
      }

      .page-autotrader-config .toggle-button {
        border: 1px solid var(--color-overlay-lg);
        background: transparent;
        color: var(--color-text-muted);
        border-radius: 6px;
        padding: 6px 14px;
        cursor: pointer;
        font-weight: 600;
        height: 28px;
        transition: border-color 0.2s ease, color 0.2s ease, opacity 0.2s ease;
      }

      .page-autotrader-config .toggle-button.active {
        border-color: var(--color-action-primary-border-strong);
        color: var(--color-text);
        background: var(--color-state-selected);
      }

      .page-autotrader-config .selector-field {
        position: relative;
      }

      .page-autotrader-config .selector-trigger {
        width: 100%;
        border-radius: var(--radius-md);
        border: 1px solid var(--color-component-dropdown-border);
        background: var(--color-component-dropdown-bg);
        color: var(--color-component-dropdown-text);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 10px 14px;
        cursor: pointer;
        transition: background 0.2s ease, border-color 0.2s ease;
      }

      .page-autotrader-config .selector-trigger:hover {
        background: var(--color-component-dropdown-hover-bg);
      }

      .page-autotrader-config .selector-trigger.is-open {
        border-color: var(--color-component-dropdown-border);
        background: var(--color-component-dropdown-selected-bg);
      }

      .page-autotrader-config .selector-trigger.is-disabled {
        opacity: 0.55;
        cursor: not-allowed;
      }

      .page-autotrader-config .selector-text {
        display: flex;
        flex-direction: column;
        gap: 4px;
        text-align: left;
      }

      .page-autotrader-config .selector-placeholder {
        color: var(--color-text-muted);
        font-size: 0.9rem;
      }

      .page-autotrader-config .selector-selection {
        color: var(--color-text-primary);
        font-weight: 600;
        font-size: 0.95rem;
      }

      .page-autotrader-config .selector-chevron {
        color: var(--color-text-tertiary);
        font-size: 0.85rem;
      }

      .page-autotrader-config .selector-panel {
        position: absolute;
        top: calc(100% + 10px);
        left: 0;
        right: 0;
        background: var(--color-component-dropdown-bg);
        border: 1px solid var(--color-component-dropdown-border);
        border-radius: var(--radius-md);
        box-shadow: 0 16px 40px var(--color-shadow-soft);
        padding: 6px 0;
        max-height: 360px;
        display: none;
        z-index: 20;
      }

      .page-autotrader-config .selector-panel.is-open {
        display: block;
      }

      .page-autotrader-config .selector-item {
        width: 100%;
        border: none;
        background: transparent;
        color: var(--color-component-dropdown-text);
        display: grid;
        grid-template-columns: 34px minmax(0, 1fr) auto;
        gap: 12px;
        align-items: center;
        padding: 10px 14px;
        text-align: left;
        cursor: pointer;
        transition: background 0.2s ease;
      }

      .page-autotrader-config .selector-item:hover {
        background: var(--color-component-dropdown-hover-bg);
        color: var(--color-component-dropdown-hover-text);
      }

      .page-autotrader-config .selector-item.selected {
        background: var(--color-component-dropdown-selected-bg);
        color: var(--color-component-dropdown-selected-text);
      }

      .page-autotrader-config .selector-item.is-disabled {
        color: var(--color-component-dropdown-disabled-text);
        opacity: 0.45;
        cursor: not-allowed;
      }

      .page-autotrader-config .selector-item.is-disabled:hover {
        background: transparent;
      }

      .page-autotrader-config .selector-logo {
        width: 34px;
        height: 34px;
        border-radius: 10px;
        background: var(--color-overlay-md);
        display: grid;
        place-items: center;
        font-weight: 700;
        color: var(--color-text-primary);
      }

      .page-autotrader-config .selector-primary {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        color: var(--color-text-primary);
      }

      .page-autotrader-config .selector-secondary {
        color: var(--color-text-muted);
        font-size: 0.8rem;
        margin-top: 2px;
      }

      .page-autotrader-config .selector-meta {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .page-autotrader-config .selector-badge {
        border: 1px solid var(--color-overlay-xxl);
        border-radius: 999px;
        padding: 1px 8px;
        font-size: 0.7rem;
        color: var(--color-text-tertiary);
      }

      .page-autotrader-config .selector-actions {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .page-autotrader-config .selector-balance {
        color: var(--color-text-secondary);
        font-size: 0.85rem;
        white-space: nowrap;
      }

      .page-autotrader-config .selector-inline-button {
        border: 1px solid var(--color-overlay-xxl);
        border-radius: 999px;
        padding: 4px 10px;
        background: transparent;
        color: var(--color-text-secondary);
        font-size: 0.7rem;
        cursor: pointer;
      }

      .page-autotrader-config .selector-indicator {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: var(--color-state-selected);
        opacity: 0;
      }

      .page-autotrader-config .selector-item.selected .selector-indicator {
        opacity: 1;
      }

      .page-autotrader-config .plan-secondary {
        color: var(--color-text-tertiary);
        font-size: 0.8rem;
        margin-top: 4px;
      }

      .page-autotrader-config .muted-button {
        border-radius: 999px;
        padding: 6px 12px;
        border: 1px solid var(--color-overlay-xl);
        background: transparent;
        color: var(--color-text-secondary);
        font-weight: 600;
        cursor: pointer;
      }

      .page-autotrader-config .pairs-table {
        width: 100%;
        border-collapse: collapse;
      }

      .page-autotrader-config .pairs-table thead,
      .page-autotrader-config .pairs-table tbody tr {
        display: table;
        width: 100%;
        table-layout: fixed;
      }

      .page-autotrader-config .pairs.config-section .pairs-table tbody {
        display: block;
        max-height: calc(
          (var(--pairs-row-height) * var(--pairs-visible-rows)) + var(--pairs-scroll-padding)
        );
        overflow-y: auto;
        scrollbar-gutter: stable;
        padding-bottom: var(--pairs-scroll-padding);
      }

      .page-autotrader-config .pairs-table tr {
        height: var(--pairs-row-height);
      }

      .page-autotrader-config .pairs-table th,
      .page-autotrader-config .pairs-table td {
        text-align: left;
        padding: 10px 8px;
        font-size: 0.82rem;
        border-bottom: 1px solid var(--color-overlay-md);
      }

      .page-autotrader-config .pairs-table th {
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--color-text-tertiary);
        font-size: 0.7rem;
      }

      .page-autotrader-config .table-input,
      .page-autotrader-config .table-select {
        width: 100%;
        background: var(--color-overlay-xs);
        border: 1px solid var(--color-overlay-md-strong);
        border-radius: 8px;
        color: var(--color-text-primary);
        padding: 6px 8px;
        font-size: 0.8rem;
      }

      .page-autotrader-config .table-select {
        background: var(--color-component-dropdown-bg);
        border-color: var(--color-component-dropdown-border);
        color: var(--color-component-dropdown-text);
      }

      .page-autotrader-config .table-input:focus,
      .page-autotrader-config .table-select:focus {
        border-color: var(--color-action-primary-border);
        outline: none;
        box-shadow: none;
      }

      .page-autotrader-config .table-action {
        border: none;
        background: none;
        color: var(--color-text-tertiary);
        cursor: pointer;
      }

      .page-autotrader-config .pairs-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
      }

      .page-autotrader-config .helper-text {
        color: var(--color-text-tertiary);
        font-size: 0.75rem;
      }

      .page-autotrader-config .summary-panel {
        position: sticky;
        top: 90px;
      }

      .page-autotrader-config .summary-header {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-bottom: 16px;
      }

      .page-autotrader-config .summary-title {
        font-size: 1.05rem;
        font-weight: 600;
      }

      .page-autotrader-config .summary-meta {
        color: var(--color-text-tertiary);
        font-size: 0.8rem;
      }

      .page-autotrader-config .summary-list {
        display: grid;
        gap: 12px;
      }

      .page-autotrader-config .summary-item {
        display: grid;
        gap: 4px;
      }

      .page-autotrader-config .summary-label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--color-text-tertiary);
      }

      .page-autotrader-config .summary-value {
        font-size: 0.9rem;
      }

      .page-autotrader-config .summary-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        --summary-tag-row-height: 26px;
        --summary-tag-row-gap: 6px;
        max-height: calc((var(--summary-tag-row-height) * 9) + (var(--summary-tag-row-gap) * 8));
        overflow-y: auto;
        overflow-x: hidden;
        scrollbar-gutter: stable;
      }

      .page-autotrader-config .summary-tag {
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid var(--color-overlay-xl);
        font-size: 0.75rem;
        line-height: 1.2;
        color: var(--color-text-tertiary);
        background: var(--color-overlay-xs-strong);
      }

      .page-autotrader-config .configurator-footer {
        margin-top: 18px;
        padding: 16px 18px;
        border-radius: var(--radius-lg);
        background: var(--color-surface-panel-muted);
        border: 1px solid var(--color-overlay-md);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
      }

      .page-autotrader-config .footer-actions {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .page-autotrader-config .primary-button {
        border-radius: 999px;
        padding: 8px 18px;
        border: 1px solid var(--color-action-primary-border-strong);
        background: var(--color-state-selected);
        color: var(--color-text);
        font-weight: 700;
        cursor: pointer;
        box-shadow: none;
      }

      .page-autotrader-config .primary-button:disabled {
        cursor: not-allowed;
        opacity: 0.6;
      }

      .page-autotrader-config .outline-button {
        border-radius: 999px;
        padding: 8px 18px;
        border: 1px solid var(--color-overlay-xl);
        background: transparent;
        color: var(--color-text-secondary);
        font-weight: 600;
        cursor: pointer;
      }

      .page-autotrader-config .empty-state {
        padding: 14px;
        border-radius: 12px;
        border: 1px dashed var(--color-overlay-lg);
        color: var(--color-text-tertiary);
        font-size: 0.85rem;
      }

      @media (max-width: 1100px) {
        .page-autotrader-config .configurator-layout {
          grid-template-columns: 1fr;
        }

        .page-autotrader-config .summary-panel {
          position: static;
        }

        .page-autotrader-config .configurator-footer {
          flex-direction: column;
          align-items: flex-start;
        }
      }

      .page-autotrader-config .trading-plan-drawer {
        position: fixed;
        top: 0;
        right: 0;
        height: 100%;
        width: min(460px, 92vw);
        background: var(--color-surface-panel);
        border-left: 1px solid var(--color-overlay-sm);
        box-shadow: none;
        transform: translateX(100%);
        transition: transform 0.25s ease;
        display: grid;
        grid-template-rows: auto 1fr auto;
        z-index: 10;
        pointer-events: none;
      }

      .page-autotrader-config .trading-plan-drawer.is-open {
        transform: translateX(0);
        pointer-events: auto;
      }

      .page-autotrader-config .drawer-header {
        padding: 16px 20px 12px;
        border-bottom: 1px solid var(--color-overlay-sm);
        background: var(--color-surface-panel-strong);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        position: relative;
      }

      .page-autotrader-config .drawer-title {
        font-size: 1.05rem;
        font-weight: 600;
        text-align: center;
        color: var(--color-text-primary);
      }

      .page-autotrader-config .drawer-subtitle {
        font-size: 0.85rem;
        color: var(--color-text-tertiary);
      }

      .page-autotrader-config .drawer-close {
        border: none;
        background: transparent;
        color: var(--color-text-muted);
        font-size: 1.2rem;
        cursor: pointer;
        position: absolute;
        right: 16px;
      }

      .page-autotrader-config .drawer-body {
        padding: 14px 20px 16px;
        display: block;
        min-height: 0;
      }

      .page-autotrader-config .drawer-section {
        display: flex;
        flex-direction: column;
        margin-bottom: 16px;
      }

      .page-autotrader-config .drawer-section:last-child {
        margin-bottom: 0;
      }

      .page-autotrader-config .drawer-section > * + * {
        margin-top: 6px;
      }

      .page-autotrader-config .drawer-section-title {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: var(--color-text-secondary);
        font-weight: 600;
      }

      .page-autotrader-config .drawer-label {
        font-size: 0.8rem;
        color: var(--color-text-primary);
      }

      .page-autotrader-config .drawer-input {
        background: var(--color-surface-panel-strong);
        border: 1px solid var(--color-overlay-md);
        border-radius: 8px;
        padding: 9px 12px;
        color: var(--color-text-primary);
      }

      .page-autotrader-config .drawer-input:focus {
        border-color: var(--color-action-primary-border-strong);
        outline: none;
        box-shadow: none;
      }

      .page-autotrader-config .drawer-helper {
        font-size: 0.78rem;
        color: var(--color-text-muted);
      }

      .page-autotrader-config .drawer-helper-emphasis {
        font-size: 0.82rem;
        color: var(--color-text-secondary);
      }

      .page-autotrader-config .pair-universe {
        display: grid;
        gap: 8px;
      }

      .page-autotrader-config .pair-selected-row {
        display: flex;
        gap: 8px;
        overflow-x: auto;
        padding-bottom: 6px;
        scrollbar-width: thin;
      }

      .page-autotrader-config .pair-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid var(--color-overlay-md-strong);
        background: var(--color-overlay-sm);
        color: var(--color-text-primary);
        font-size: 0.75rem;
        white-space: nowrap;
      }

      .page-autotrader-config .pair-chip button {
        border: none;
        background: transparent;
        color: var(--color-text-tertiary);
        cursor: pointer;
        font-size: 0.85rem;
        line-height: 1;
      }

      .page-autotrader-config .pair-chip button:hover {
        color: var(--color-text-primary);
      }

      .page-autotrader-config .pair-selector-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 8px 12px;
        border-radius: 8px;
        border: 1px solid var(--color-component-dropdown-border);
        background: var(--color-component-dropdown-bg);
        cursor: pointer;
        transition: border-color 0.2s ease, opacity 0.2s ease;
      }

      .page-autotrader-config .pair-selector-bar:hover {
        border-color: var(--color-component-dropdown-border);
      }

      .page-autotrader-config .pair-selector-label {
        font-size: 0.82rem;
        color: var(--color-text);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .page-autotrader-config .pair-selector-meta {
        font-size: 0.75rem;
        color: var(--color-text-muted);
      }

      .page-autotrader-config .pair-selector-action {
        font-size: 0.75rem;
        color: var(--color-text-muted);
        border: none;
        background: transparent;
        cursor: pointer;
      }

      .page-autotrader-config .pair-dropdown {
        border: 1px solid var(--color-component-dropdown-border);
        border-radius: 8px;
        background: var(--color-component-dropdown-bg);
        padding: 10px;
        display: none;
        gap: 10px;
      }

      .page-autotrader-config .pair-dropdown.is-open {
        display: grid;
      }

      .page-autotrader-config .pair-search {
        background: var(--color-app-background);
        border: 1px solid var(--color-overlay-md);
        border-radius: 8px;
        padding: 8px 10px;
        color: var(--color-text-primary);
      }

      .page-autotrader-config .pair-search:focus {
        border-color: var(--color-action-primary-border-strong);
        outline: none;
        box-shadow: none;
      }

      .page-autotrader-config .pair-tooltip {
        font-size: 0.75rem;
        color: var(--color-text-tertiary);
        padding: 8px 10px;
        border-radius: 10px;
        background: var(--color-overlay-xs);
        border: 1px solid var(--color-overlay-md);
      }

      .page-autotrader-config .pair-list {
        display: grid;
        gap: 6px;
        max-height: 220px;
        padding-right: 4px;
        min-height: 0;
      }

      .page-autotrader-config .pair-option {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid transparent;
        background: transparent;
        font-size: 0.85rem;
        color: var(--color-component-dropdown-text);
        cursor: pointer;
        transition: border-color 0.2s ease, background 0.2s ease;
      }

      .page-autotrader-config .pair-option:hover {
        background: var(--color-component-dropdown-hover-bg);
        color: var(--color-component-dropdown-hover-text);
      }

      .page-autotrader-config .pair-option.is-selected {
        border-color: var(--color-component-dropdown-border);
        background: var(--color-component-dropdown-selected-bg);
        color: var(--color-component-dropdown-selected-text);
      }

      .page-autotrader-config .pair-icon {
        width: 28px;
        height: 28px;
        border-radius: 8px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: var(--color-overlay-md);
        color: var(--color-text);
        font-size: 0.7rem;
        font-weight: 600;
      }

      .page-autotrader-config .pair-row-meta {
        margin-left: auto;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 0.72rem;
        color: var(--color-text-tertiary);
      }

      .page-autotrader-config .pair-star {
        color: var(--color-text-disabled);
      }

      .page-autotrader-config .pair-check {
        color: var(--color-action-primary);
        font-weight: 700;
      }

      .page-autotrader-config .pair-overlay {
        position: absolute;
        inset: 0;
        background: var(--color-surface-panel-strong);
        display: none;
        flex-direction: column;
        gap: 12px;
        padding: 18px;
        z-index: 2;
      }

      .page-autotrader-config .pair-overlay.is-open {
        display: flex;
      }

      .page-autotrader-config .pair-overlay-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .page-autotrader-config .pair-overlay-title {
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--color-text-primary);
      }

      .page-autotrader-config .pair-overlay-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        min-height: 0;
      }

      .page-autotrader-config .pair-overlay-footer {
        margin-top: auto;
        display: flex;
        justify-content: flex-end;
      }

      .page-autotrader-config .drawer-footer {
        padding: 12px 20px;
        border-top: 1px solid var(--color-overlay-sm);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        background: var(--color-surface-panel-strong);
      }

      .page-autotrader-config .form-helper,
      .page-autotrader-config .input-hint {
        color: var(--color-text-tertiary);
      }

      .page-autotrader-config .drawer-input::placeholder,
      .page-autotrader-config .pair-search::placeholder,
      .page-autotrader-config .table-input::placeholder {
        color: var(--color-text-disabled);
      }
    </style>
  </head>
  <body class="page-autotrader-config" data-mode="edit">
    <div id="app" class="app">
      <header class="header section section--header section-header">
        <div class="section-header">
          <h1 class="section-title">Autotrader Configurator</h1>
        </div>
      </header>
      <div class="app-body">
        <aside data-sidebar-slot></aside>
        <main class="main">
          <div class="configurator-layout">
            <section class="config-panel">
              <div class="config-section" id="section-market">
                <div class="config-section-header">
                  <div>
                    <div class="config-section-title">Market</div>
                    <div class="config-section-description">Choose the market type for this configuration.</div>
                  </div>
                  <div class="toggle-group" role="group" aria-label="Market type">
                    <button class="toggle-button" type="button" data-market="Spot">Spot</button>
                    <button class="toggle-button" type="button" data-market="Futures">Futures</button>
                  </div>
                </div>
              </div>
              <div class="config-section" id="section-exchange">
                <div class="config-section-header">
                  <div>
                    <div class="config-section-title">Exchange</div>
                    <div class="config-section-description">Select an exchange compatible with the chosen market.</div>
                  </div>
                  <button class="muted-button" type="button">Connect New Exchange</button>
                </div>
                <div class="selector-field" id="exchange-selector">
                  <button class="selector-trigger" type="button" id="exchange-trigger" aria-expanded="false">
                    <div class="selector-text">
                      <span class="selector-placeholder" id="exchange-placeholder">Select account</span>
                      <span class="selector-selection" id="exchange-selection"></span>
                    </div>
                    <span class="selector-chevron">▾</span>
                  </button>
                  <div class="selector-panel scrollable" id="exchange-panel" role="listbox"></div>
                </div>
                <div class="empty-state" id="exchange-empty">Select a market to view available accounts.</div>
              </div>
              <div class="config-section" id="section-trading-plan">
                <div class="config-section-header">
                  <div>
                    <div class="config-section-title">Trading Plan</div>
                    <div class="config-section-description">Pick a plan that matches your execution style.</div>
                  </div>
                  <button class="muted-button" type="button" id="open-plan-drawer">Create Trading Plan</button>
                </div>
                <div class="selector-field" id="plan-selector">
                  <button class="selector-trigger" type="button" id="plan-trigger" aria-expanded="false">
                    <div class="selector-text">
                      <span class="selector-placeholder" id="plan-placeholder">Select trading plan</span>
                      <span class="selector-selection" id="plan-selection"></span>
                    </div>
                    <span class="selector-chevron">▾</span>
                  </button>
                  <div class="selector-panel scrollable" id="plan-panel" role="listbox"></div>
                </div>
                <div class="empty-state" id="plan-empty">Select a market to view trading plans.</div>
              </div>
              <div class="config-section pairs" id="section-pairs">
                <div class="config-section-header">
                  <div>
                    <div class="config-section-title">Pairs Configuration</div>
                    <div class="config-section-description">Each pair represents an individual autotrader instance.</div>
                  </div>
                </div>
                <table class="pairs-table">
                  <thead id="pairs-head"></thead>
                  <tbody id="pairs-body"></tbody>
                </table>
                <div class="pairs-actions">
                  <span class="helper-text" id="pairs-helper">Add pairs to spin up new autotraders.</span>
                  <button class="muted-button" type="button" id="add-pair">Add Pair</button>
                </div>
              </div>
            </section>
            <aside class="summary-panel">
              <div class="summary-header">
                <span class="summary-title">Autotrader Preview</span>
                <span class="summary-meta">Live summary of the configuration</span>
              </div>
              <div class="summary-list" id="summary-list">
                <div class="summary-item">
                  <span class="summary-label">Market</span>
                  <span class="summary-value" id="summary-market">—</span>
                </div>
                <div class="summary-item">
                  <span class="summary-label">Exchange</span>
                  <span class="summary-value" id="summary-exchange">—</span>
                </div>
                <div class="summary-item">
                  <span class="summary-label">Trading Plan</span>
                  <span class="summary-value" id="summary-plan">—</span>
                </div>
                <div class="summary-item">
                  <span class="summary-label">Number of Autotraders</span>
                  <span class="summary-value" id="summary-count">0</span>
                </div>
                <div class="summary-item">
                  <span class="summary-label">Total Capital</span>
                  <span class="summary-value" id="summary-capital">$0</span>
                </div>
                <div class="summary-item">
                  <span class="summary-label">Pairs</span>
                  <div class="summary-tags" id="summary-pairs"></div>
                </div>
              </div>
            </aside>
          </div>
          <footer class="configurator-footer">
            <div>
              <div class="config-section-title" id="footer-title">Ready to create new autotraders?</div>
              <div class="config-section-description">Changes reflect instantly on the right-hand preview.</div>
            </div>
            <div class="footer-actions">
              <button class="outline-button" type="button" id="cancel-config">Cancel</button>
              <button class="primary-button" type="button" id="submit-config">Create Autotrader</button>
            </div>
          </footer>
        </main>
      </div>
    </div>
    <aside class="trading-plan-drawer" id="trading-plan-drawer" aria-hidden="true">
      <div class="drawer-header">
        <div class="drawer-title">Create Trading Plan</div>
        <button class="drawer-close" type="button" id="close-plan-drawer" aria-label="Close">×</button>
      </div>
      <div class="drawer-body scrollable">
        <div class="drawer-section">
          <div class="drawer-section-title">Plan Basics</div>
          <label class="drawer-label" for="plan-name-input">Plan name</label>
          <input class="drawer-input" type="text" id="plan-name-input" placeholder="Plan name" />
          <div class="drawer-helper">
            Trading Plans define which pairs can be used when creating autotraders.
          </div>
        </div>
        <div class="drawer-section">
          <div class="drawer-section-title">Market Compatibility</div>
          <div class="toggle-group" role="group" aria-label="Trading plan market">
            <button class="toggle-button" type="button" data-plan-market="Spot">Spot</button>
            <button class="toggle-button" type="button" data-plan-market="Futures">Futures</button>
          </div>
        </div>
        <div class="drawer-section">
          <div class="drawer-section-title">Pair Universe Selection</div>
          <div class="drawer-helper-emphasis">Select at least one pair.</div>
          <div class="pair-universe">
            <div class="pair-selected-row" id="pair-selected-row"></div>
            <div class="pair-selector-bar" id="pair-selector-bar">
              <div class="pair-selector-label">
                <span class="pair-selector-dot">●</span>
                <span id="pair-selector-count">0 pairs selected</span>
                <span class="pair-selector-meta" id="pair-selector-quote"></span>
              </div>
              <button class="pair-selector-action" type="button" id="pair-unselect-all">Unselect all (0)</button>
            </div>
            <div class="pair-dropdown" id="pair-dropdown">
              <input class="pair-search" type="text" id="pair-search-input" placeholder="Search pairs" />
              <div class="pair-tooltip" id="pair-tooltip">
                Apply one strategy to multiple pairs. Select pairs with the same quote currency.
              </div>
              <div class="pair-list scrollable" id="pair-universe-list"></div>
            </div>
          </div>
          <div class="drawer-helper">
            Only these pairs will be available when creating autotraders using this plan.
          </div>
        </div>
        <div class="pair-overlay" id="pair-overlay">
          <div class="pair-overlay-header">
            <div class="pair-overlay-title" id="pair-overlay-title">Selected pairs (0)</div>
            <button class="drawer-close" type="button" id="pair-overlay-close" aria-label="Close">×</button>
          </div>
          <input class="pair-search" type="text" id="pair-overlay-search" placeholder="Search selected pairs" />
          <div class="pair-overlay-chips scrollable" id="pair-overlay-chips"></div>
          <div class="pair-overlay-footer">
            <button class="pair-selector-action" type="button" id="pair-overlay-unselect">Unselect all pairs</button>
          </div>
        </div>
      </div>
      <div class="drawer-footer">
        <button class="outline-button" type="button" id="cancel-plan-drawer">Cancel</button>
        <button class="primary-button" type="button" id="save-plan-drawer">Save Trading Plan</button>
      </div>
    </aside>
    <script type="module" src="../../src/scripts/main.js"></script>
    <script type="module">
      const autotraderConfig = {
        market: null,
        exchange: null,
        tradingPlan: null,
        pairs: [],
      };

      const exchangeOptions = [
        {
          id: "binance",
          name: "Binance",
          market: "Spot",
          status: "Connected",
          account: "Primary API •••• 4821",
          balance: "$18,240",
        },
        {
          id: "coinbase",
          name: "Coinbase Prime",
          market: "Spot",
          status: "Connected",
          account: "Desk A •••• 9014",
          balance: "$42,900",
        },
        {
          id: "kraken",
          name: "Kraken",
          market: "Spot",
          status: "Disconnected",
          account: "Legacy •••• 2407",
          balance: "$2,380",
          needsUpdate: true,
        },
        {
          id: "binance-futures",
          name: "Binance Futures",
          market: "Futures",
          status: "Connected",
          account: "Perp Desk •••• 1159",
          balance: "$27,100",
        },
        {
          id: "bybit",
          name: "Bybit",
          market: "Futures",
          status: "Connected",
          account: "Alt Macro •••• 7725",
          balance: "$11,480",
        },
        {
          id: "okx",
          name: "OKX",
          market: "Futures",
          status: "Disconnected",
          account: "Quant Ops •••• 3360",
          balance: "$6,750",
          needsUpdate: true,
        },
      ];

      let tradingPlans = [
        {
          id: "momentum-spot",
          name: "Momentum Core",
          market: "Spot",
          leverageType: "No Leverage",
          pairs: "Top 10",
          pairUniverse: ["BTC/USDT", "ETH/USDT", "SOL/USDT", "AVAX/USDT"],
        },
        {
          id: "mean-reversion-spot",
          name: "Mean Reversion",
          market: "Spot",
          leverageType: "No Leverage",
          pairs: "Top 25",
          pairUniverse: ["BTC/USDT", "ETH/USDT", "SOL/USDT", "AVAX/USDT"],
        },
        {
          id: "momentum-futures",
          name: "Momentum Turbo",
          market: "Futures",
          leverageType: "Cross",
          pairs: "Top 15",
          pairUniverse: ["BTC/USDT Perp", "ETH/USDT Perp", "SOL/USDT Perp", "BNB/USDT Perp"],
        },
        {
          id: "hedged-futures",
          name: "Hedged Breakout",
          market: "Futures",
          leverageType: "Isolated",
          pairs: "Top 8",
          pairUniverse: ["BTC/USDT Perp", "ETH/USDT Perp", "SOL/USDT Perp", "BNB/USDT Perp"],
        },
      ];

      const availablePairs = {
        Spot: ["BTC/USDT", "ETH/USDT", "SOL/USDT", "AVAX/USDT"],
        Futures: ["BTC/USDT Perp", "ETH/USDT Perp", "SOL/USDT Perp", "BNB/USDT Perp"],
      };

      const elements = {
        toggleButtons: document.querySelectorAll(".toggle-button"),
        exchangeSelector: document.getElementById("exchange-selector"),
        exchangeTrigger: document.getElementById("exchange-trigger"),
        exchangePanel: document.getElementById("exchange-panel"),
        exchangePlaceholder: document.getElementById("exchange-placeholder"),
        exchangeSelection: document.getElementById("exchange-selection"),
        exchangeEmpty: document.getElementById("exchange-empty"),
        planSelector: document.getElementById("plan-selector"),
        planTrigger: document.getElementById("plan-trigger"),
        planPanel: document.getElementById("plan-panel"),
        planPlaceholder: document.getElementById("plan-placeholder"),
        planSelection: document.getElementById("plan-selection"),
        planEmpty: document.getElementById("plan-empty"),
        pairsHead: document.getElementById("pairs-head"),
        pairsBody: document.getElementById("pairs-body"),
        addPairButton: document.getElementById("add-pair"),
        pairsHelper: document.getElementById("pairs-helper"),
        summaryMarket: document.getElementById("summary-market"),
        summaryExchange: document.getElementById("summary-exchange"),
        summaryPlan: document.getElementById("summary-plan"),
        summaryCount: document.getElementById("summary-count"),
        summaryCapital: document.getElementById("summary-capital"),
        summaryPairs: document.getElementById("summary-pairs"),
        cancelButton: document.getElementById("cancel-config"),
        submitButton: document.getElementById("submit-config"),
        footerTitle: document.getElementById("footer-title"),
        openPlanDrawer: document.getElementById("open-plan-drawer"),
        planDrawer: document.getElementById("trading-plan-drawer"),
        closePlanDrawer: document.getElementById("close-plan-drawer"),
        cancelPlanDrawer: document.getElementById("cancel-plan-drawer"),
        savePlanDrawer: document.getElementById("save-plan-drawer"),
        planNameInput: document.getElementById("plan-name-input"),
        planMarketButtons: document.querySelectorAll("[data-plan-market]"),
        pairUniverseList: document.getElementById("pair-universe-list"),
        pairSelectedRow: document.getElementById("pair-selected-row"),
        pairSearchInput: document.getElementById("pair-search-input"),
        pairSelectorBar: document.getElementById("pair-selector-bar"),
        pairSelectorCount: document.getElementById("pair-selector-count"),
        pairSelectorQuote: document.getElementById("pair-selector-quote"),
        pairUnselectAll: document.getElementById("pair-unselect-all"),
        pairDropdown: document.getElementById("pair-dropdown"),
        pairTooltip: document.getElementById("pair-tooltip"),
        pairOverlay: document.getElementById("pair-overlay"),
        pairOverlayTitle: document.getElementById("pair-overlay-title"),
        pairOverlayClose: document.getElementById("pair-overlay-close"),
        pairOverlaySearch: document.getElementById("pair-overlay-search"),
        pairOverlayChips: document.getElementById("pair-overlay-chips"),
        pairOverlayUnselect: document.getElementById("pair-overlay-unselect"),
      };

      const drawerState = {
        name: "",
        market: "Spot",
        selectedPairs: [],
        quoteCurrency: "",
        tooltipShown: false,
      };

      const mode = document.body.dataset.mode || "create";

      const modeCopy = {
        create: {
          footerTitle: "Ready to create new autotraders?",
          submitLabel: "Create Autotrader",
        },
        edit: {
          footerTitle: "Update this autotrader configuration.",
          submitLabel: "Save Changes",
        },
        clone: {
          footerTitle: "Clone settings into a new autotrader set.",
          submitLabel: "Create Clone",
        },
      };

      const resolveModeCopy = () => {
        const copy = modeCopy[mode] || modeCopy.create;
        elements.footerTitle.textContent = copy.footerTitle;
        elements.submitButton.textContent = copy.submitLabel;
      };

      const applyDefaultMarket = () => {
        if (autotraderConfig.market) {
          return;
        }
        autotraderConfig.market = "Spot";
      };

      const updateMarket = (market) => {
        autotraderConfig.market = market;
        autotraderConfig.exchange = null;
        autotraderConfig.tradingPlan = null;
        autotraderConfig.pairs = [];
        closeSelector("exchange");
        closeSelector("plan");
        render();
      };

      const updateExchange = (exchangeId) => {
        const exchange = exchangeOptions.find((item) => item.id === exchangeId) || null;
        autotraderConfig.exchange = exchange;
        closeSelector("exchange");
        render();
      };

      const updateTradingPlan = (planId) => {
        const plan = tradingPlans.find((item) => item.id === planId) || null;
        autotraderConfig.tradingPlan = plan;
        if (plan?.pairUniverse?.length) {
          autotraderConfig.pairs = autotraderConfig.pairs.map((pair) => ({
            ...pair,
            pair: plan.pairUniverse.includes(pair.pair) ? pair.pair : plan.pairUniverse[0],
          }));
        }
        closeSelector("plan");
        render();
      };

      const closeSelector = (key) => {
        const trigger = elements[`${key}Trigger`];
        const panel = elements[`${key}Panel`];
        if (!trigger || !panel) {
          return;
        }
        panel.classList.remove("is-open");
        trigger.classList.remove("is-open");
        trigger.setAttribute("aria-expanded", "false");
      };

      const toggleSelector = (key) => {
        const trigger = elements[`${key}Trigger`];
        const panel = elements[`${key}Panel`];
        if (!trigger || !panel || trigger.classList.contains("is-disabled")) {
          return;
        }
        const isOpen = panel.classList.contains("is-open");
        closeSelector("exchange");
        closeSelector("plan");
        if (!isOpen) {
          panel.classList.add("is-open");
          trigger.classList.add("is-open");
          trigger.setAttribute("aria-expanded", "true");
        }
      };

      const setSelectorValue = (key, value) => {
        const placeholder = elements[`${key}Placeholder`];
        const selection = elements[`${key}Selection`];
        if (!placeholder || !selection) {
          return;
        }
        if (value) {
          selection.textContent = value;
          selection.style.display = "block";
          placeholder.style.display = "none";
        } else {
          selection.textContent = "";
          selection.style.display = "none";
          placeholder.style.display = "block";
        }
      };

      const updatePair = (index, key, value) => {
        const pair = autotraderConfig.pairs[index];
        if (!pair) {
          return;
        }
        pair[key] = value;
        render();
      };

      const addPair = () => {
        if (!autotraderConfig.market) {
          return;
        }
        const pairs = availablePairs[autotraderConfig.market] || [];
        const defaultPair = pairs.find((pair) =>
          !autotraderConfig.pairs.some((entry) => entry.pair === pair)
        ) || pairs[0];

        autotraderConfig.pairs.push({
          pair: defaultPair || "",
          tradeAmount: autotraderConfig.market === "Futures" ? 5000 : 2000,
          leverage: autotraderConfig.market === "Futures" ? 3 : 1,
          leverageType: autotraderConfig.market === "Futures" ? "Cross" : "Spot",
        });
        render();
      };

      const removePair = (index) => {
        autotraderConfig.pairs.splice(index, 1);
        render();
      };

      const formatCurrency = (value) => {
        if (!Number.isFinite(value)) {
          return "$0";
        }
        return `$${value.toLocaleString()}`;
      };

      const calculateTotalCapital = () =>
        autotraderConfig.pairs.reduce(
          (sum, pair) => sum + (Number(pair.tradeAmount) || 0),
          0
        );

      const renderAccounts = () => {
        elements.exchangePanel.innerHTML = "";
        const hasMarket = Boolean(autotraderConfig.market);
        elements.exchangeEmpty.style.display = hasMarket ? "none" : "block";
        elements.exchangeTrigger.disabled = !hasMarket;
        elements.exchangeTrigger.classList.toggle("is-disabled", !hasMarket);

        if (!hasMarket) {
          setSelectorValue("exchange", "");
          return;
        }

        const compatible = exchangeOptions.filter((item) => item.market === autotraderConfig.market);
        const incompatible = exchangeOptions.filter((item) => item.market !== autotraderConfig.market);
        const sorted = [...compatible, ...incompatible];

        sorted.forEach((exchange) => {
          const isCompatible = exchange.market === autotraderConfig.market;
          const item = document.createElement("button");
          item.type = "button";
          item.className = "selector-item";
          item.setAttribute("role", "option");
          item.setAttribute("aria-selected", autotraderConfig.exchange?.id === exchange.id ? "true" : "false");
          if (autotraderConfig.exchange?.id === exchange.id) {
            item.classList.add("selected");
          }
          if (!isCompatible) {
            item.classList.add("is-disabled");
            item.disabled = true;
          }
          item.innerHTML = `
            <div class="selector-logo">${exchange.name?.charAt(0) || "E"}</div>
            <div>
              <div class="selector-primary">
                <span>${exchange.name}</span>
                <span class="selector-badge">${exchange.market}</span>
              </div>
              <div class="selector-secondary">${exchange.account || "API •••• 0000"}</div>
            </div>
            <div class="selector-actions">
              <span class="selector-balance">${exchange.balance || "$0"}</span>
              ${
                exchange.needsUpdate
                  ? `<button class="selector-inline-button" type="button" data-action="update">Update API Key</button>`
                  : ""
              }
              <span class="selector-indicator"></span>
            </div>
          `;

          if (exchange.needsUpdate) {
            const action = item.querySelector('[data-action="update"]');
            if (action) {
              action.addEventListener("click", (event) => {
                event.stopPropagation();
              });
              if (!isCompatible) {
                action.disabled = true;
              }
            }
          }

          if (isCompatible) {
            item.addEventListener("click", () => updateExchange(exchange.id));
          }
          elements.exchangePanel.appendChild(item);
        });

        const exchangeLabel = autotraderConfig.exchange
          ? `${autotraderConfig.exchange.name} · ${autotraderConfig.exchange.account || "API"}`
          : "";
        setSelectorValue("exchange", exchangeLabel);
      };

      const renderPlans = () => {
        elements.planPanel.innerHTML = "";
        const hasMarket = Boolean(autotraderConfig.market);
        elements.planEmpty.style.display = hasMarket ? "none" : "block";
        elements.planTrigger.disabled = !hasMarket;
        elements.planTrigger.classList.toggle("is-disabled", !hasMarket);

        if (!hasMarket) {
          setSelectorValue("plan", "");
          return;
        }

        const compatible = tradingPlans.filter((plan) => plan.market === autotraderConfig.market);
        const incompatible = tradingPlans.filter((plan) => plan.market !== autotraderConfig.market);
        const sorted = [...compatible, ...incompatible];

        sorted.forEach((plan) => {
          const isCompatible = plan.market === autotraderConfig.market;
          const item = document.createElement("button");
          item.type = "button";
          item.className = "selector-item";
          item.setAttribute("role", "option");
          item.setAttribute("aria-selected", autotraderConfig.tradingPlan?.id === plan.id ? "true" : "false");
          if (autotraderConfig.tradingPlan?.id === plan.id) {
            item.classList.add("selected");
          }
          if (!isCompatible) {
            item.classList.add("is-disabled");
            item.disabled = true;
          }

          const coverage = plan.pairs ? `${plan.pairs} pairs` : "Pairs not specified";
          item.innerHTML = `
            <div class="selector-logo">${plan.name?.charAt(0) || "P"}</div>
            <div>
              <div class="selector-primary">${plan.name}</div>
              <div class="plan-secondary">${plan.market} • ${coverage}</div>
            </div>
            <div class="selector-actions">
              <span class="selector-indicator"></span>
            </div>
          `;

          if (isCompatible) {
            item.addEventListener("click", () => updateTradingPlan(plan.id));
          }
          elements.planPanel.appendChild(item);
        });

        const planLabel = autotraderConfig.tradingPlan
          ? `${autotraderConfig.tradingPlan.name} · ${autotraderConfig.tradingPlan.market}`
          : "";
        setSelectorValue("plan", planLabel);
      };

      const renderPairs = () => {
        elements.pairsBody.innerHTML = "";
        const isSpot = autotraderConfig.market === "Spot";
        const showLeverage = autotraderConfig.market === "Futures";
        const available =
          autotraderConfig.tradingPlan?.pairUniverse?.length
            ? autotraderConfig.tradingPlan.pairUniverse
            : availablePairs[autotraderConfig.market] || [];

        elements.pairsHead.innerHTML = showLeverage
          ? `
            <tr>
              <th>Pair</th>
              <th>Trade Amount (USD)</th>
              <th>Leverage</th>
              <th>Leverage Type</th>
              <th></th>
            </tr>
          `
          : `
            <tr>
              <th>Pair</th>
              <th>Trade Amount (USD)</th>
              <th></th>
            </tr>
          `;

        if (isSpot) {
          autotraderConfig.pairs = autotraderConfig.pairs.map((pair) => ({
            ...pair,
            leverage: 1,
            leverageType: "Spot",
          }));
        }

        autotraderConfig.pairs.forEach((pair, index) => {
          const leverageDisabled = autotraderConfig.market === "Spot";
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>
              <select class="table-select" data-index="${index}" data-key="pair">
                ${available
                  .map(
                    (option) =>
                      `<option value="${option}" ${option === pair.pair ? "selected" : ""}>${option}</option>`
                  )
                  .join("")}
              </select>
            </td>
            <td>
              <input class="table-input" type="number" min="0" step="100" value="${pair.tradeAmount}" data-index="${index}" data-key="tradeAmount" />
            </td>
            ${
              showLeverage
                ? `
                  <td>
                    <input class="table-input" type="number" min="1" max="100" step="1" value="${pair.leverage}" data-index="${index}" data-key="leverage" />
                  </td>
                  <td>
                    <select class="table-select" data-index="${index}" data-key="leverageType">
                      <option value="Spot" ${pair.leverageType === "Spot" ? "selected" : ""}>Spot</option>
                      <option value="Cross" ${pair.leverageType === "Cross" ? "selected" : ""}>Cross</option>
                      <option value="Isolated" ${pair.leverageType === "Isolated" ? "selected" : ""}>Isolated</option>
                    </select>
                  </td>
                `
                : ""
            }
            <td>
              <button class="table-action" type="button" data-remove="${index}">Remove</button>
            </td>
          `;
          elements.pairsBody.appendChild(row);
        });

        elements.addPairButton.disabled = !autotraderConfig.market;
        elements.pairsHelper.textContent = autotraderConfig.market
          ? "Add pairs to spin up new autotraders."
          : "Select a market before adding pairs.";
      };

      const renderSummary = () => {
        elements.summaryMarket.textContent = autotraderConfig.market || "—";
        elements.summaryExchange.textContent = autotraderConfig.exchange?.name || "—";
        elements.summaryPlan.textContent = autotraderConfig.tradingPlan?.name || "—";
        elements.summaryCount.textContent = autotraderConfig.pairs.length.toString();
        elements.summaryCapital.textContent = formatCurrency(calculateTotalCapital());
        elements.summaryPairs.innerHTML = "";

        if (!autotraderConfig.pairs.length) {
          const tag = document.createElement("span");
          tag.className = "summary-tag";
          tag.textContent = "No pairs selected";
          elements.summaryPairs.appendChild(tag);
          return;
        }

        autotraderConfig.pairs.forEach((pair) => {
          const tag = document.createElement("span");
          tag.className = "summary-tag";
          tag.textContent = pair.pair || "Pair";
          elements.summaryPairs.appendChild(tag);
        });
      };

      const renderToggle = () => {
        elements.toggleButtons.forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.market === autotraderConfig.market);
        });
      };

      const canSubmit = () =>
        autotraderConfig.market &&
        autotraderConfig.exchange &&
        autotraderConfig.tradingPlan &&
        autotraderConfig.pairs.length > 0 &&
        autotraderConfig.pairs.every((pair) => Number(pair.tradeAmount) > 0);

      const renderSubmitState = () => {
        elements.submitButton.disabled = !canSubmit();
      };

      const openPlanDrawer = () => {
        drawerState.name = "";
        drawerState.market = autotraderConfig.market || "Spot";
        drawerState.selectedPairs = [];
        drawerState.quoteCurrency = "";
        drawerState.tooltipShown = false;
        elements.pairSearchInput.value = "";
        elements.pairOverlaySearch.value = "";
        elements.pairDropdown.classList.remove("is-open");
        elements.pairOverlay.classList.remove("is-open");
        renderPlanDrawer();
        elements.planDrawer.classList.add("is-open");
        elements.planDrawer.setAttribute("aria-hidden", "false");
      };

      const closePlanDrawer = () => {
        elements.planDrawer.classList.remove("is-open");
        elements.planDrawer.setAttribute("aria-hidden", "true");
        elements.pairDropdown.classList.remove("is-open");
        elements.pairOverlay.classList.remove("is-open");
      };

      const parseQuoteCurrency = (pair) => {
        const parts = pair.split("/");
        if (parts.length < 2) {
          return "";
        }
        return parts[1].split(" ")[0];
      };

      const renderPlanDrawer = () => {
        elements.planNameInput.value = drawerState.name;
        elements.planMarketButtons.forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.planMarket === drawerState.market);
        });

        const options = availablePairs[drawerState.market] || [];
        const searchTerm = elements.pairSearchInput.value.trim().toLowerCase();
        const filteredOptions = options.filter((pair) => pair.toLowerCase().includes(searchTerm));
        elements.pairSelectedRow.innerHTML = "";
        if (drawerState.selectedPairs.length) {
          drawerState.selectedPairs.forEach((pair) => {
            const chip = document.createElement("div");
            chip.className = "pair-chip";
            chip.innerHTML = `
              <span>${pair}</span>
              <button type="button" aria-label="Remove ${pair}" data-remove-pair="${pair}">×</button>
            `;
            elements.pairSelectedRow.appendChild(chip);
          });
        } else {
          const emptyChip = document.createElement("span");
          emptyChip.className = "helper-text";
          emptyChip.textContent = "Select at least one pair.";
          elements.pairSelectedRow.appendChild(emptyChip);
        }

        const count = drawerState.selectedPairs.length;
        elements.pairSelectorCount.textContent = `${count} ${count === 1 ? "pair" : "pairs"}`;
        elements.pairUnselectAll.textContent = `Unselect all (${count})`;
        elements.pairUnselectAll.style.visibility = count ? "visible" : "hidden";
        elements.pairSelectorQuote.textContent = drawerState.quoteCurrency
          ? drawerState.quoteCurrency
          : "Select quote";

        if (drawerState.tooltipShown) {
          elements.pairTooltip.style.display = "none";
        } else {
          elements.pairTooltip.style.display = "block";
        }

        elements.pairUniverseList.innerHTML = "";
        filteredOptions.forEach((pair) => {
          const row = document.createElement("div");
          row.className = "pair-option";
          if (drawerState.selectedPairs.includes(pair)) {
            row.classList.add("is-selected");
          }
          const symbol = pair.split("/")[0] || pair;
          const quote = parseQuoteCurrency(pair);
          row.innerHTML = `
            <span class="pair-star">★</span>
            <span class="pair-icon">${symbol.slice(0, 3).toUpperCase()}</span>
            <span>${pair}</span>
            <span class="pair-row-meta">
              <span>${quote}</span>
              ${drawerState.selectedPairs.includes(pair) ? '<span class="pair-check">✓</span>' : ""}
            </span>
          `;
          row.addEventListener("click", () => togglePairSelection(pair));
          elements.pairUniverseList.appendChild(row);
        });

        const overlaySearch = elements.pairOverlaySearch.value.trim().toLowerCase();
        elements.pairOverlayTitle.textContent = `Selected pairs (${count})`;
        elements.pairOverlayChips.innerHTML = "";
        drawerState.selectedPairs
          .filter((pair) => pair.toLowerCase().includes(overlaySearch))
          .forEach((pair) => {
            const chip = document.createElement("div");
            chip.className = "pair-chip";
            chip.innerHTML = `
              <span>${pair}</span>
              <button type="button" aria-label="Remove ${pair}" data-remove-pair="${pair}">×</button>
            `;
            elements.pairOverlayChips.appendChild(chip);
          });

        elements.savePlanDrawer.disabled = !drawerState.name.trim() || drawerState.selectedPairs.length === 0;
      };

      const savePlanDrawer = () => {
        if (!drawerState.name.trim() || drawerState.selectedPairs.length === 0) {
          return;
        }
        const newPlan = {
          id: `custom-${Date.now()}`,
          name: drawerState.name.trim(),
          market: drawerState.market,
          leverageType: "Custom",
          pairs: `${drawerState.selectedPairs.length} pairs`,
          pairUniverse: [...drawerState.selectedPairs],
        };
        tradingPlans = [newPlan, ...tradingPlans];
        autotraderConfig.tradingPlan = newPlan;
        closePlanDrawer();
        render();
      };

      const togglePairSelection = (pair) => {
        if (drawerState.selectedPairs.includes(pair)) {
          drawerState.selectedPairs = drawerState.selectedPairs.filter((item) => item !== pair);
        } else {
          const quote = parseQuoteCurrency(pair);
          if (drawerState.quoteCurrency && drawerState.quoteCurrency !== quote) {
            if (!drawerState.tooltipShown) {
              drawerState.tooltipShown = true;
            }
            renderPlanDrawer();
            return;
          }
          drawerState.selectedPairs = [...drawerState.selectedPairs, pair];
          drawerState.quoteCurrency = quote;
          if (!drawerState.tooltipShown) {
            drawerState.tooltipShown = true;
          }
        }
        if (!drawerState.selectedPairs.length) {
          drawerState.quoteCurrency = "";
        }
        renderPlanDrawer();
      };

      const render = () => {
        renderToggle();
        renderAccounts();
        renderPlans();
        renderPairs();
        renderSummary();
        renderSubmitState();
      };

      elements.toggleButtons.forEach((button) => {
        button.addEventListener("click", () => updateMarket(button.dataset.market));
      });

      elements.exchangeTrigger.addEventListener("click", (event) => {
        event.stopPropagation();
        toggleSelector("exchange");
      });

      elements.planTrigger.addEventListener("click", (event) => {
        event.stopPropagation();
        toggleSelector("plan");
      });

      elements.addPairButton.addEventListener("click", addPair);

      elements.openPlanDrawer.addEventListener("click", openPlanDrawer);
      elements.closePlanDrawer.addEventListener("click", closePlanDrawer);
      elements.cancelPlanDrawer.addEventListener("click", closePlanDrawer);
      elements.savePlanDrawer.addEventListener("click", savePlanDrawer);

      elements.planNameInput.addEventListener("input", (event) => {
        drawerState.name = event.target.value;
        renderPlanDrawer();
      });

      elements.pairSearchInput.addEventListener("input", () => {
        renderPlanDrawer();
      });

      elements.planMarketButtons.forEach((button) => {
        button.addEventListener("click", () => {
          drawerState.market = button.dataset.planMarket;
          drawerState.selectedPairs = [];
          drawerState.quoteCurrency = "";
          drawerState.tooltipShown = false;
          elements.pairSearchInput.value = "";
          elements.pairOverlaySearch.value = "";
          renderPlanDrawer();
        });
      });

      elements.pairSelectedRow.addEventListener("click", (event) => {
        const target = event.target;
        if (!(target instanceof HTMLButtonElement)) {
          return;
        }
        const value = target.dataset.removePair;
        if (value) {
          togglePairSelection(value);
        }
      });

      elements.pairOverlayChips.addEventListener("click", (event) => {
        const target = event.target;
        if (!(target instanceof HTMLButtonElement)) {
          return;
        }
        const value = target.dataset.removePair;
        if (value) {
          togglePairSelection(value);
        }
      });

      elements.pairOverlaySearch.addEventListener("input", () => {
        renderPlanDrawer();
      });

      elements.pairSelectorBar.addEventListener("click", () => {
        if (drawerState.selectedPairs.length) {
          elements.pairOverlay.classList.add("is-open");
          elements.pairDropdown.classList.remove("is-open");
        } else {
          elements.pairDropdown.classList.toggle("is-open");
        }
      });

      elements.pairOverlayClose.addEventListener("click", () => {
        elements.pairOverlay.classList.remove("is-open");
      });

      elements.pairUnselectAll.addEventListener("click", (event) => {
        event.stopPropagation();
        drawerState.selectedPairs = [];
        drawerState.quoteCurrency = "";
        renderPlanDrawer();
      });

      elements.pairOverlayUnselect.addEventListener("click", () => {
        drawerState.selectedPairs = [];
        drawerState.quoteCurrency = "";
        elements.pairOverlay.classList.remove("is-open");
        renderPlanDrawer();
      });

      elements.pairsBody.addEventListener("input", (event) => {
        const target = event.target;
        if (!(target instanceof HTMLInputElement || target instanceof HTMLSelectElement)) {
          return;
        }
        const index = Number(target.dataset.index);
        const key = target.dataset.key;
        if (!key) {
          return;
        }
        if (autotraderConfig.market === "Spot" && (key === "leverage" || key === "leverageType")) {
          return;
        }
        updatePair(index, key, target.value);
      });

      elements.pairsBody.addEventListener("click", (event) => {
        const target = event.target;
        if (!(target instanceof HTMLButtonElement)) {
          return;
        }
        const index = Number(target.dataset.remove);
        if (!Number.isNaN(index)) {
          removePair(index);
        }
      });


      elements.cancelButton.addEventListener("click", () => {
        window.location.href = "../autotraders.html";
      });

      elements.submitButton.addEventListener("click", () => {
        if (!canSubmit()) {
          return;
        }
        if (mode !== "create") {
          window.alert("This route is stubbed for now.");
          return;
        }
        const createdAt = Date.now();
        const exchangeName = autotraderConfig.exchange?.name || "Exchange";
        const planName = autotraderConfig.tradingPlan?.name || "Autotrader";
        const newAutotraders = autotraderConfig.pairs.map((pair, idx) => ({
          id: createdAt + idx,
          name: planName,
          pair: pair.pair,
          exchange: exchangeName,
          capital: Number(pair.tradeAmount) || 0,
          pnl: 0,
          winRate: 0,
          running: 0,
          status: "STOPPED",
        }));

        const storageKey = "byscript_custom_autotraders";
        const stored = JSON.parse(localStorage.getItem(storageKey) || "[]");
        localStorage.setItem(storageKey, JSON.stringify([...newAutotraders, ...stored]));
        window.location.href = "../autotraders.html";
      });

      resolveModeCopy();
      applyDefaultMarket();
      render();

      document.addEventListener("click", (event) => {
        if (!elements.exchangeSelector.contains(event.target)) {
          closeSelector("exchange");
        }
        if (!elements.planSelector.contains(event.target)) {
          closeSelector("plan");
        }
      });

      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape" && elements.planDrawer.classList.contains("is-open")) {
          closePlanDrawer();
          return;
        }
        if (event.key === "Escape") {
          closeSelector("exchange");
          closeSelector("plan");
        }
      });
    </script>
  </body>
</html>
